{"ID":"20251117134116-p0fq1gu","Spec":"1","Type":"NodeDocument","Properties":{"id":"20251117134116-p0fq1gu","title":"问题","type":"doc","updated":"20251117134249"},"Children":[{"ID":"20251117134116-416jk8m","Type":"NodeParagraph","Properties":{"id":"20251117134116-416jk8m","updated":"20251117134137"},"Children":[{"Type":"NodeText","Data":"擦除 SQUASHFS 根文件系统后，会报错："}]},{"ID":"20251117134138-b7mbc01","Type":"NodeParagraph","Properties":{"id":"20251117134138-b7mbc01","updated":"20251117134144"},"Children":[{"Type":"NodeText","Data":"SQUASHFS error: xz decompression failed\nSQUASHFS error: Failed to read block 0x9a7f8"}]},{"ID":"20251117134150-c8s8orh","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20251117134150-c8s8orh","updated":"20251117134219"},"Children":[{"Type":"NodeText","Data":"根本原因"}]},{"ID":"20251117134150-mklujay","Type":"NodeParagraph","Properties":{"id":"20251117134150-mklujay","updated":"20251117134150"},"Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"70MB 小内存系统的 Slab Cache 容量极限问题"}]},{"ID":"20251117134151-bo8tldv","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20251117134151-bo8tldv","updated":"20251117134157"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"aWZjb25maWc="},{"Type":"NodeCodeBlockCode","Data":"1. Slab Cache 100% 满\n   ├─ inode_cache: 2373/2373 (100%)\n   ├─ dentry: 3030/3030 (100%)\n   └─ squashfs_inode_cache: 108/108 (100%)\n\n2. GPIO 操作需要分配新的 inode\n   └─ open(\"/sys/class/gpio/...\") \n\n3. Cache 已满，触发内核回收\n   └─ shrink_slab()\n\n4. 回收过程需要验证 inode\n   ├─ 扫描 squashfs_inode_cache (108 个)\n   └─ 读取磁盘验证元数据 (0x9a7f8)\n\n5. SQUASHFS 已被擦除\n   └─ XZ 解压失败 → 报错\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20251117134219-17gu680","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20251117134219-17gu680","updated":"20251117134249"},"Children":[{"Type":"NodeText","Data":"为什么是 GPIO 操作？"}]},{"ID":"20251117134219-vzrqp5t","Type":"NodeList","ListData":{},"Properties":{"id":"20251117134219-vzrqp5t","updated":"20251117134219"},"Children":[{"ID":"20251117134219-12dct7a","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251117134219-12dct7a","updated":"20251117134219"},"Children":[{"ID":"20251117134219-fo3l36i","Type":"NodeParagraph","Properties":{"id":"20251117134219-fo3l36i","updated":"20251117134219"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"MTD 写入"},{"Type":"NodeText","Data":"​：只需少量内核内存（"},{"Type":"NodeBackslash","Data":"span","Children":[{"Type":"NodeText","Data":"~"}]},{"Type":"NodeText","Data":"10KB），不触发回收"}]}]},{"ID":"20251117134219-3uxvu16","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251117134219-3uxvu16","updated":"20251117134219"},"Children":[{"ID":"20251117134219-2je66zy","Type":"NodeParagraph","Properties":{"id":"20251117134219-2je66zy","updated":"20251117134219"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"GPIO 操作"},{"Type":"NodeText","Data":"​：需要从 slab cache 分配 dentry/inode/kobject，cache 已满，触发回收"}]}]}]},{"ID":"20251117134220-zihgfxp","Type":"NodeParagraph","Properties":{"id":"20251117134220-zihgfxp","updated":"20251117134240"},"Children":[{"Type":"NodeText","Data":"三种解决方案的原理："}]},{"ID":"20251117134238-i9w6enc","Type":"NodeTable","TableAligns":[0,0,0],"Properties":{"colgroup":"||","id":"20251117134238-i9w6enc","updated":"20251117134238"},"Children":[{"Type":"NodeTableHead","Data":"thead","Children":[{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"th","Children":[{"Type":"NodeText","Data":"方案"}]},{"Type":"NodeTableCell","Data":"th","Children":[{"Type":"NodeText","Data":"原理"}]},{"Type":"NodeTableCell","Data":"th","Children":[{"Type":"NodeText","Data":"效果"}]}]}]},{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"清理 cache"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"echo 3 \u0026gt; /proc/sys/vm/drop_caches"},{"Type":"NodeText","Data":"​"},{"Type":"NodeBackslash","Data":"span","Children":[{"Type":"NodeText","Data":"\u003c"}]},{"Type":"NodeText","Data":"br"},{"Type":"NodeBackslash","Data":"span","Children":[{"Type":"NodeText","Data":"\u003e"}]},{"Type":"NodeText","Data":"清空 SQUASHFS inode cache，腾出空间"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"✅ 暂时有效"}]}]},{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"扩大内存"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"70MB → 128MB"},{"Type":"NodeBackslash","Data":"span","Children":[{"Type":"NodeText","Data":"\u003c"}]},{"Type":"NodeText","Data":"br"},{"Type":"NodeBackslash","Data":"span","Children":[{"Type":"NodeText","Data":"\u003e"}]},{"Type":"NodeText","Data":"Slab cache 容量翻倍，使用率降到 50%"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"✅ 彻底解决"}]}]},{"Type":"NodeTableRow","Data":"tr","Children":[{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"避免 GPIO"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"注释"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"SerialWaitOnBusy/SetOnBusy"},{"Type":"NodeText","Data":"​"},{"Type":"NodeBackslash","Data":"span","Children":[{"Type":"NodeText","Data":"\u003c"}]},{"Type":"NodeText","Data":"br"},{"Type":"NodeBackslash","Data":"span","Children":[{"Type":"NodeText","Data":"\u003e"}]},{"Type":"NodeText","Data":"不分配新 inode，不触发回收"}]},{"Type":"NodeTableCell","Data":"td","Children":[{"Type":"NodeText","Data":"✅ 立即有效"}]}]}]},{"ID":"20251117134249-qztf7cc","Type":"NodeParagraph","Properties":{"id":"20251117134249-qztf7cc","updated":"20251117134249"}}]}