{"ID":"20251030221820-yfsydy6","Spec":"1","Type":"NodeDocument","Properties":{"id":"20251030221820-yfsydy6","title":"Cell 和 RefCell","type":"doc","updated":"20251102002401"},"Children":[{"ID":"20251030221820-afbdves","Type":"NodeParagraph","Properties":{"id":"20251030221820-afbdves","updated":"20251030222052"},"Children":[{"Type":"NodeText","Data":"Rust 提供了 Cell 和 RefCell 用于内部可变性，正常的代码实现来说（要么一个可变借用，要么多个不可变借用）"}]},{"ID":"20251030222055-z7ams07","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20251030222055-z7ams07","updated":"20251030223737"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://course.rs/advance/smart-pointer/cell-refcell.html#cell","TextMarkTextContent":"Cell"}]},{"ID":"20251030222055-vs0as88","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20251030222055-vs0as88","updated":"20251030223723"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"aWZjb25maWc="},{"Type":"NodeCodeBlockCode","Data":"use std::cell::Cell;\n\nlet c = Cell::new(5);\nlet r = \u0026c;  // 不可变引用\n\nr.set(10);  // ✅ 可以修改！\n\nprintln!(\"{}\", c.get());  // 输出：10，值确实变了！\n\nuse std::cell::Cell;\nfn main() {\n  let c = Cell::new(\"asdf\");\n  let one = c.get();\n  c.set(\"qwer\");\n  let two = c.get();\n  println!(\"{},{}\", one, two);\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20251030223641-k8se86j","Type":"NodeList","ListData":{},"Properties":{"id":"20251030223641-k8se86j","updated":"20251030223641"},"Children":[{"ID":"20251030223641-omzmt84","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251030223641-omzmt84","updated":"20251030223641"},"Children":[{"ID":"20251030223641-rbcgmwq","Type":"NodeParagraph","Properties":{"id":"20251030223641-rbcgmwq","updated":"20251030223641"},"Children":[{"Type":"NodeText","Data":"只能用于 Copy 类型（简单值类型）"}]}]},{"ID":"20251030223641-6qkd3zl","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251030223641-6qkd3zl","updated":"20251030223641"},"Children":[{"ID":"20251030223641-21r7nkx","Type":"NodeParagraph","Properties":{"id":"20251030223641-21r7nkx","updated":"20251030223641"},"Children":[{"Type":"NodeText","Data":"不能跨线程共享（Cell 不是 Sync）"}]}]},{"ID":"20251030223641-21ik2sw","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251030223641-21ik2sw","updated":"20251030223641"},"Children":[{"ID":"20251030223641-39iumlm","Type":"NodeParagraph","Properties":{"id":"20251030223641-39iumlm","updated":"20251030223641"},"Children":[{"Type":"NodeText","Data":"不暴露内部引用"}]}]}]},{"ID":"20251030223650-t0q2nar","Type":"NodeParagraph","Properties":{"id":"20251030223650-t0q2nar","updated":"20251030223736"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"String"},{"Type":"NodeText","Data":"​ 没有实现 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Copy"},{"Type":"NodeText","Data":"​ 特征"}]},{"ID":"20251030223741-anwz7rr","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20251030223741-anwz7rr","updated":"20251030224904"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://course.rs/advance/smart-pointer/cell-refcell.html#refcell","TextMarkTextContent":"RefCell"}]},{"ID":"20251030224455-i8266xt","Type":"NodeParagraph","Properties":{"id":"20251030224455-i8266xt","updated":"20251030224455"},"Children":[{"Type":"NodeText","Data":"由于 Cell 类型针对的是实现了 Copy 特征的值类型，因此在实际开发中，Cell 使用的并不多，因为我们要解决的往往是可变、不可变引用共存导致的问题，此时就需要借助于 RefCell 来达成目的。"}]},{"ID":"20251030223741-vvybvxg","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20251030223741-vvybvxg","linewrap":"true","updated":"20251030224516"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"aWZjb25maWc="},{"Type":"NodeCodeBlockCode","Data":"RefCell 实际上并没有解决可变引用和引用可以共存的问题，只是将报错从编译期推迟到运行时，从编译器错误变成了 panic 异常\n\nuse std::cell::RefCell;\n\nfn main() {\n    let s = RefCell::new(String::from(\"hello, world\"));\n    let s1 = s.borrow();\n    let s2 = s.borrow_mut();\n\n    println!(\"{},{}\", s1, s2);\n}\n\n上面代码在编译期不会报任何错误，你可以顺利运行程序：\n但是依然会因为违背了借用规则导致了运行期 panic\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20251030224633-7mptjgi","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20251030224633-7mptjgi","updated":"20251030224904"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://course.rs/advance/smart-pointer/cell-refcell.html#refcell-%E4%B8%BA%E4%BD%95%E5%AD%98%E5%9C%A8","TextMarkTextContent":"RefCell 为何存在"}]},{"ID":"20251030224657-677ddwh","Type":"NodeParagraph","Properties":{"id":"20251030224657-677ddwh","updated":"20251030224709"},"Children":[{"Type":"NodeText","Data":"Rust 编译期的"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"宁可错杀，绝不放过"},{"Type":"NodeText","Data":"的原则，当编译器不能确定你的代码是否正确时，就统统会判定为错误，因此难免会导致一些误报。"}]},{"ID":"20251030224713-k2lg3c6","Type":"NodeParagraph","Properties":{"id":"20251030224713-k2lg3c6","updated":"20251030224714"},"Children":[{"Type":"NodeText","Data":"而 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"RefCell"},{"Type":"NodeText","Data":"​ 正是"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"用于你确信代码是正确的，而编译器却发生了误判时"},{"Type":"NodeText","Data":"。"}]},{"ID":"20251030224907-nmwvc1y","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20251030224907-nmwvc1y","updated":"20251030224908"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://course.rs/advance/smart-pointer/cell-refcell.html#refcell-%E7%AE%80%E5%8D%95%E6%80%BB%E7%BB%93","TextMarkTextContent":"RefCell 简单总结"}]},{"ID":"20251030224904-y8javw7","Type":"NodeList","ListData":{},"Properties":{"id":"20251030224904-y8javw7","updated":"20251030224904"},"Children":[{"ID":"20251030224904-8ts6nfc","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251030224904-8ts6nfc","updated":"20251030224904"},"Children":[{"ID":"20251030224904-uovtseh","Type":"NodeParagraph","Properties":{"id":"20251030224904-uovtseh","updated":"20251030224904"},"Children":[{"Type":"NodeText","Data":"与 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Cell"},{"Type":"NodeText","Data":"​ 用于可 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Copy"},{"Type":"NodeText","Data":"​ 的值不同，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"RefCell"},{"Type":"NodeText","Data":"​ 用于引用"}]}]},{"ID":"20251030224904-boqc9ip","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251030224904-boqc9ip","updated":"20251030224904"},"Children":[{"ID":"20251030224904-xjnybej","Type":"NodeParagraph","Properties":{"id":"20251030224904-xjnybej","updated":"20251030224904"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"RefCell"},{"Type":"NodeText","Data":"​ 只是将借用规则从编译期推迟到程序运行期，并不能帮你绕过这个规则"}]}]},{"ID":"20251030224904-3qy3g3e","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251030224904-3qy3g3e","updated":"20251030224904"},"Children":[{"ID":"20251030224904-o4tpmca","Type":"NodeParagraph","Properties":{"id":"20251030224904-o4tpmca","updated":"20251030224904"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"RefCell"},{"Type":"NodeText","Data":"​ 适用于编译期误报或者一个引用被在多处代码使用、修改以至于难于管理借用关系时"}]}]},{"ID":"20251030224904-unypecq","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251030224904-unypecq","updated":"20251030224904"},"Children":[{"ID":"20251030224904-wsfbuj1","Type":"NodeParagraph","Properties":{"id":"20251030224904-wsfbuj1","updated":"20251030224904"},"Children":[{"Type":"NodeText","Data":"使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"RefCell"},{"Type":"NodeText","Data":"​ 时，违背借用规则会导致运行期的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"panic"},{"Type":"NodeText","Data":"​"}]}]}]},{"ID":"20251030225038-mmf218m","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20251030225038-mmf218m","updated":"20251030230627"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://course.rs/advance/smart-pointer/cell-refcell.html#%E9%80%89%E6%8B%A9-cell-%E8%BF%98%E6%98%AF-refcell","TextMarkTextContent":"选择 "},{"Type":"NodeTextMark","TextMarkType":"a code","TextMarkAHref":"https://course.rs/advance/smart-pointer/cell-refcell.html#%E9%80%89%E6%8B%A9-cell-%E8%BF%98%E6%98%AF-refcell","TextMarkTextContent":"Cell"},{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://course.rs/advance/smart-pointer/cell-refcell.html#%E9%80%89%E6%8B%A9-cell-%E8%BF%98%E6%98%AF-refcell","TextMarkTextContent":" 还是 "},{"Type":"NodeTextMark","TextMarkType":"a code","TextMarkAHref":"https://course.rs/advance/smart-pointer/cell-refcell.html#%E9%80%89%E6%8B%A9-cell-%E8%BF%98%E6%98%AF-refcell","TextMarkTextContent":"RefCell"},{"Type":"NodeText","Data":"​"}]},{"ID":"20251030225039-c5bcxft","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20251030225039-c5bcxft","updated":"20251030225043"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"aWZjb25maWc="},{"Type":"NodeCodeBlockCode","Data":"Cell 只适用于 Copy 类型，用于提供值，而 RefCell 用于提供引用\nCell 不会 panic，而 RefCell 会\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20251030225047-d4y9ehk","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20251030225047-d4y9ehk","updated":"20251030230627"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://course.rs/advance/smart-pointer/cell-refcell.html#%E6%80%A7%E8%83%BD%E6%AF%94%E8%BE%83","TextMarkTextContent":"性能比较"}]},{"ID":"20251030225048-ypltir9","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20251030225048-ypltir9","updated":"20251030230627"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"aWZjb25maWc="},{"Type":"NodeCodeBlockCode","Data":"当非要使用内部可变性时，首选 Cell，只有你的类型没有实现 Copy 时，才去选择 RefCell\n因为refcell要先借用在调用方法\n\nuse std::cell::RefCell;\n\nfn main() {\n    let c = RefCell::new(String::from(\"asdf\"));\n    \n    // 获取不可变引用并复制值（因为 String 不实现 Copy，需要显式克隆）\n    let one = c.borrow().clone();\n    \n    // 获取可变引用并修改值\n    *c.borrow_mut() = String::from(\"qwer\");\n    \n    // 再次获取值\n    let two = c.borrow().clone();\n    \n    println!(\"{}, {}\", one, two); // 输出：asdf, qwer\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20251030230636-na4h6z8","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20251030230636-na4h6z8","updated":"20251101234150"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://course.rs/advance/smart-pointer/cell-refcell.html#%E5%86%85%E9%83%A8%E5%8F%AF%E5%8F%98%E6%80%A7","TextMarkTextContent":"内部可变性"}]},{"ID":"20251030230636-wi00txf","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20251030230636-wi00txf","updated":"20251101234145"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"aWZjb25maWc="},{"Type":"NodeCodeBlockCode","Data":"// 定义在外部库中的特征\npub trait Messenger {\n    fn send(\u0026self, msg: String);  //固定是 \u0026self\n}\n\n// --------------------------\n// 我们的代码中的数据结构和实现\nstruct MsgQueue {\n    msg_cache: Vec\u003cString\u003e,\n}\n\nimpl Messenger for MsgQueue {\n    fn send(\u0026self, msg: String) {\n        self.msg_cache.push(msg)  //但是这里又想改，错误！\n    }\n}\n\nuse std::cell::RefCell;\npub trait Messenger {\n    fn send(\u0026self, msg: String);\n}\n\npub struct MsgQueue {\n    msg_cache: RefCell\u003cVec\u003cString\u003e\u003e, //通过包裹一层 RefCell，成功的让 \u0026self 中的 msg_cache 成为一个可变值，然后实现对其的修改。\n}\n\nimpl Messenger for MsgQueue {\n    fn send(\u0026self, msg: String) {\n        self.msg_cache.borrow_mut().push(msg) //使用recell\n    }\n}\nfn main() {\n    let mq = MsgQueue {\n        msg_cache: RefCell::new(Vec::new()),\n    };\n    mq.send(\"hello, world\".to_string());\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20251101234150-t31aozd","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20251101234150-t31aozd","updated":"20251101235916"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://course.rs/advance/smart-pointer/cell-refcell.html#rc--refcell-%E7%BB%84%E5%90%88%E4%BD%BF%E7%94%A8","TextMarkTextContent":"Rc + RefCell 组合使用"}]},{"ID":"20251101234500-mjg05a8","Type":"NodeParagraph","Properties":{"id":"20251101234500-mjg05a8","updated":"20251101235224"},"Children":[{"Type":"NodeText","Data":"多引用并且修改，最后输出相同值，因为是多引用"}]},{"ID":"20251101234151-rt7hyfl","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20251101234151-rt7hyfl","updated":"20251101234459"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"aWZjb25maWc="},{"Type":"NodeCodeBlockCode","Data":"use std::cell::RefCell;\nuse std::rc::Rc;\nfn main() {\n    let s = Rc::new(RefCell::new(\"我很善变，还拥有多个主人\".to_string()));\n\n    let s1 = s.clone();\n    let s2 = s.clone();\n    // let mut s2 = s.borrow_mut();\n    s2.borrow_mut().push_str(\", oh yeah!\");\n\n    println!(\"{:?}\\n{:?}\\n{:?}\", s, s1, s2);\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20251101235424-h1ezxnr","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20251101235424-h1ezxnr","updated":"20251101235916"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://course.rs/advance/smart-pointer/cell-refcell.html#%E6%80%A7%E8%83%BD%E6%8D%9F%E8%80%97","TextMarkTextContent":"性能损耗"}]},{"ID":"20251101235425-n1kypqd","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20251101235425-n1kypqd","updated":"20251101235916"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"aWZjb25maWc="},{"Type":"NodeCodeBlockCode","Data":"两者结合在一起使用的性能其实非常高，大致相当于没有线程安全版本的 C++ std::shared_ptr 指针，线程安全在哪个语言中开销都不小\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20251101235856-hbahs62","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20251101235856-hbahs62","updated":"20251101235921"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://course.rs/advance/smart-pointer/cell-refcell.html#%E5%86%85%E5%AD%98%E6%8D%9F%E8%80%97","TextMarkTextContent":"内存损耗"}]},{"ID":"20251101235858-i05emw8","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20251101235858-i05emw8","updated":"20251101235921"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"aWZjb25maWc="},{"Type":"NodeCodeBlockCode","Data":"两者结合的数据结构与下面类似：\n\nstruct Wrapper\u003cT\u003e {\n    // Rc\n    strong_count: usize,\n    weak_count: usize,\n\n    // Refcell\n    borrow_count: isize,\n\n    // 包裹的数据\n    item: T,\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20251102000152-5pdfoxz","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20251102000152-5pdfoxz","updated":"20251102001101"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://course.rs/advance/smart-pointer/cell-refcell.html#cpu-%E6%8D%9F%E8%80%97","TextMarkTextContent":"CPU 损耗"}]},{"ID":"20251102000242-milksvq","Type":"NodeList","ListData":{},"Properties":{"id":"20251102000242-milksvq","updated":"20251102000248"},"Children":[{"ID":"20251102000242-8s3w31q","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251102000242-8s3w31q","updated":"20251102000242"},"Children":[{"ID":"20251102000242-vhfl3kk","Type":"NodeParagraph","Properties":{"id":"20251102000242-vhfl3kk","updated":"20251102000242"},"Children":[{"Type":"NodeText","Data":"对 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Rc\u0026lt;T\u0026gt;"},{"Type":"NodeText","Data":"​ 解引用是免费的（编译期），但是 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"*"},{"Type":"NodeText","Data":"​ 带来的间接取值并不免费"}]}]},{"ID":"20251102000242-cj0j50k","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251102000242-cj0j50k","updated":"20251102000242"},"Children":[{"ID":"20251102000242-8t80aih","Type":"NodeParagraph","Properties":{"id":"20251102000242-8t80aih","updated":"20251102000242"},"Children":[{"Type":"NodeText","Data":"克隆 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Rc\u0026lt;T\u0026gt;"},{"Type":"NodeText","Data":"​ 需要将当前的引用计数跟 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"0"},{"Type":"NodeText","Data":"​ 和 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"usize::Max"},{"Type":"NodeText","Data":"​ 进行一次比较，然后将计数值加 1"}]}]},{"ID":"20251102000242-io9wmej","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251102000242-io9wmej","updated":"20251102000242"},"Children":[{"ID":"20251102000242-wu75ji8","Type":"NodeParagraph","Properties":{"id":"20251102000242-wu75ji8","updated":"20251102000242"},"Children":[{"Type":"NodeText","Data":"释放（drop） "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Rc\u0026lt;T\u0026gt;"},{"Type":"NodeText","Data":"​ 需要将计数值减 1， 然后跟 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"0"},{"Type":"NodeText","Data":"​ 进行一次比较"}]}]},{"ID":"20251102000242-asv6ahy","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251102000242-asv6ahy","updated":"20251102000242"},"Children":[{"ID":"20251102000242-owc54ai","Type":"NodeParagraph","Properties":{"id":"20251102000242-owc54ai","updated":"20251102000242"},"Children":[{"Type":"NodeText","Data":"对 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"RefCell"},{"Type":"NodeText","Data":"​ 进行不可变借用，需要将 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"isize"},{"Type":"NodeText","Data":"​ 类型的借用计数加 1，然后跟 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"0"},{"Type":"NodeText","Data":"​ 进行比较"}]}]},{"ID":"20251102000242-tbppphz","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251102000242-tbppphz","updated":"20251102000242"},"Children":[{"ID":"20251102000242-id1u7gl","Type":"NodeParagraph","Properties":{"id":"20251102000242-id1u7gl","updated":"20251102000242"},"Children":[{"Type":"NodeText","Data":"对 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"RefCell "},{"Type":"NodeText","Data":"​的不可变借用进行释放，需要将 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"isize"},{"Type":"NodeText","Data":"​ 减 1"}]}]},{"ID":"20251102000242-zuupt9b","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251102000242-zuupt9b","updated":"20251102000242"},"Children":[{"ID":"20251102000242-ly1ylpk","Type":"NodeParagraph","Properties":{"id":"20251102000242-ly1ylpk","updated":"20251102000242"},"Children":[{"Type":"NodeText","Data":"对 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"RefCell"},{"Type":"NodeText","Data":"​ 的可变借用大致流程跟上面差不多，但是需要先跟 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"0"},{"Type":"NodeText","Data":"​ 比较，然后再减 1"}]}]},{"ID":"20251102000242-nm6t53f","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251102000242-nm6t53f","updated":"20251102000242"},"Children":[{"ID":"20251102000242-ihj92a4","Type":"NodeParagraph","Properties":{"id":"20251102000242-ihj92a4","updated":"20251102000242"},"Children":[{"Type":"NodeText","Data":"对 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"RefCell"},{"Type":"NodeText","Data":"​ 的可变借用进行释放，需要将 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"isize"},{"Type":"NodeText","Data":"​ 加 1"}]}]},{"ID":"20251102000248-bwast0l","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251102000248-bwast0l","updated":"20251102000248"},"Children":[{"ID":"20251102000248-8bczhnt","Type":"NodeParagraph","Properties":{"id":"20251102000248-8bczhnt","updated":"20251102000248"},"Children":[{"Type":"NodeText","Data":"其实这些细节不必过于关注，只要知道 CPU 消耗也非常低，甚至编译器还会对此进行进一步优化！"}]}]}]},{"ID":"20251102001106-nv8m9ak","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20251102001106-nv8m9ak","updated":"20251102002401"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://course.rs/advance/smart-pointer/cell-refcell.html#%E9%80%9A%E8%BF%87-cellfrom_mut-%E8%A7%A3%E5%86%B3%E5%80%9F%E7%94%A8%E5%86%B2%E7%AA%81","TextMarkTextContent":"通过 "},{"Type":"NodeTextMark","TextMarkType":"a code","TextMarkAHref":"https://course.rs/advance/smart-pointer/cell-refcell.html#%E9%80%9A%E8%BF%87-cellfrom_mut-%E8%A7%A3%E5%86%B3%E5%80%9F%E7%94%A8%E5%86%B2%E7%AA%81","TextMarkTextContent":"Cell::from_mut"},{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://course.rs/advance/smart-pointer/cell-refcell.html#%E9%80%9A%E8%BF%87-cellfrom_mut-%E8%A7%A3%E5%86%B3%E5%80%9F%E7%94%A8%E5%86%B2%E7%AA%81","TextMarkTextContent":" 解决借用冲突"}]},{"ID":"20251102001113-j8vfflm","Type":"NodeParagraph","Properties":{"id":"20251102001113-j8vfflm","updated":"20251102001113"},"Children":[{"Type":"NodeText","Data":"在 Rust 1.37 版本中新增了两个非常实用的方法："}]},{"ID":"20251102001113-yyqoare","Type":"NodeList","ListData":{},"Properties":{"id":"20251102001113-yyqoare","updated":"20251102001113"},"Children":[{"ID":"20251102001113-hq6r4ye","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251102001113-hq6r4ye","updated":"20251102001113"},"Children":[{"ID":"20251102001113-8rldy4u","Type":"NodeParagraph","Properties":{"id":"20251102001113-8rldy4u","updated":"20251102001113"},"Children":[{"Type":"NodeText","Data":"Cell::from"},{"Type":"NodeBackslash","Data":"span","Children":[{"Type":"NodeText","Data":"_"}]},{"Type":"NodeText","Data":"mut，该方法将 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"\u0026amp;mut T"},{"Type":"NodeText","Data":"​ 转为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"\u0026amp;Cell\u0026lt;T\u0026gt;"},{"Type":"NodeText","Data":"​"}]}]},{"ID":"20251102001113-sg00r4t","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251102001113-sg00r4t","updated":"20251102001113"},"Children":[{"ID":"20251102001113-cgwvfbg","Type":"NodeParagraph","Properties":{"id":"20251102001113-cgwvfbg","updated":"20251102001113"},"Children":[{"Type":"NodeText","Data":"Cell::as"},{"Type":"NodeBackslash","Data":"span","Children":[{"Type":"NodeText","Data":"_"}]},{"Type":"NodeText","Data":"slice"},{"Type":"NodeBackslash","Data":"span","Children":[{"Type":"NodeText","Data":"_"}]},{"Type":"NodeText","Data":"of"},{"Type":"NodeBackslash","Data":"span","Children":[{"Type":"NodeText","Data":"_"}]},{"Type":"NodeText","Data":"cells，该方法将 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"\u0026amp;Cell\u0026lt;[T]\u0026gt;"},{"Type":"NodeText","Data":"​ 转为 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"\u0026amp;[Cell\u0026lt;T\u0026gt;]"},{"Type":"NodeText","Data":"​"}]}]}]},{"ID":"20251102001114-oeys72f","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20251102001114-oeys72f","updated":"20251102001615"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"aWZjb25maWc="},{"Type":"NodeCodeBlockCode","Data":"有点小问题捏\nfn is_even(i: i32) -\u003e bool {\n    i % 2 == 0\n}\n\nfn retain_even(nums: \u0026mut Vec\u003ci32\u003e) {\n    let mut i = 0;\n    for num in nums.iter().filter(|\u0026num| is_even(*num)) {  //不可变借用\n        nums[i] = *num;  //可变借用\n        i += 1;\n    }\n    nums.truncate(i);\n}\n\n//修改后正常\nuse std::cell::Cell;\nfn retain_even(nums: \u0026mut Vec\u003ci32\u003e) {\n    let slice: \u0026[Cell\u003ci32\u003e] = Cell::from_mut(\u0026mut nums[..])\n        .as_slice_of_cells();\n\n    let mut i = 0;\n    for num in slice.iter().filter(|num| is_even(num.get())) {\n        slice[i].set(num.get());\n        i += 1;\n    }\n\n    nums.truncate(i);\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20251102002401-06u5hkq","Type":"NodeParagraph","Properties":{"id":"20251102002401-06u5hkq","updated":"20251102002401"}}]}