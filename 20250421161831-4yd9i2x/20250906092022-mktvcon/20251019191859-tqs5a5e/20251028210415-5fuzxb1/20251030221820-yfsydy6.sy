{"ID":"20251030221820-yfsydy6","Spec":"1","Type":"NodeDocument","Properties":{"id":"20251030221820-yfsydy6","title":"Cell 和 RefCell","type":"doc","updated":"20251030230637"},"Children":[{"ID":"20251030221820-afbdves","Type":"NodeParagraph","Properties":{"id":"20251030221820-afbdves","updated":"20251030222052"},"Children":[{"Type":"NodeText","Data":"Rust 提供了 Cell 和 RefCell 用于内部可变性，正常的代码实现来说（要么一个可变借用，要么多个不可变借用）"}]},{"ID":"20251030222055-z7ams07","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20251030222055-z7ams07","updated":"20251030223737"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://course.rs/advance/smart-pointer/cell-refcell.html#cell","TextMarkTextContent":"Cell"}]},{"ID":"20251030222055-vs0as88","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20251030222055-vs0as88","updated":"20251030223723"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"aWZjb25maWc="},{"Type":"NodeCodeBlockCode","Data":"use std::cell::Cell;\n\nlet c = Cell::new(5);\nlet r = \u0026c;  // 不可变引用\n\nr.set(10);  // ✅ 可以修改！\n\nprintln!(\"{}\", c.get());  // 输出：10，值确实变了！\n\nuse std::cell::Cell;\nfn main() {\n  let c = Cell::new(\"asdf\");\n  let one = c.get();\n  c.set(\"qwer\");\n  let two = c.get();\n  println!(\"{},{}\", one, two);\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20251030223641-k8se86j","Type":"NodeList","ListData":{},"Properties":{"id":"20251030223641-k8se86j","updated":"20251030223641"},"Children":[{"ID":"20251030223641-omzmt84","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251030223641-omzmt84","updated":"20251030223641"},"Children":[{"ID":"20251030223641-rbcgmwq","Type":"NodeParagraph","Properties":{"id":"20251030223641-rbcgmwq","updated":"20251030223641"},"Children":[{"Type":"NodeText","Data":"只能用于 Copy 类型（简单值类型）"}]}]},{"ID":"20251030223641-6qkd3zl","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251030223641-6qkd3zl","updated":"20251030223641"},"Children":[{"ID":"20251030223641-21r7nkx","Type":"NodeParagraph","Properties":{"id":"20251030223641-21r7nkx","updated":"20251030223641"},"Children":[{"Type":"NodeText","Data":"不能跨线程共享（Cell 不是 Sync）"}]}]},{"ID":"20251030223641-21ik2sw","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251030223641-21ik2sw","updated":"20251030223641"},"Children":[{"ID":"20251030223641-39iumlm","Type":"NodeParagraph","Properties":{"id":"20251030223641-39iumlm","updated":"20251030223641"},"Children":[{"Type":"NodeText","Data":"不暴露内部引用"}]}]}]},{"ID":"20251030223650-t0q2nar","Type":"NodeParagraph","Properties":{"id":"20251030223650-t0q2nar","updated":"20251030223736"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"String"},{"Type":"NodeText","Data":"​ 没有实现 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Copy"},{"Type":"NodeText","Data":"​ 特征"}]},{"ID":"20251030223741-anwz7rr","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20251030223741-anwz7rr","updated":"20251030224904"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://course.rs/advance/smart-pointer/cell-refcell.html#refcell","TextMarkTextContent":"RefCell"}]},{"ID":"20251030224455-i8266xt","Type":"NodeParagraph","Properties":{"id":"20251030224455-i8266xt","updated":"20251030224455"},"Children":[{"Type":"NodeText","Data":"由于 Cell 类型针对的是实现了 Copy 特征的值类型，因此在实际开发中，Cell 使用的并不多，因为我们要解决的往往是可变、不可变引用共存导致的问题，此时就需要借助于 RefCell 来达成目的。"}]},{"ID":"20251030223741-vvybvxg","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20251030223741-vvybvxg","linewrap":"true","updated":"20251030224516"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"aWZjb25maWc="},{"Type":"NodeCodeBlockCode","Data":"RefCell 实际上并没有解决可变引用和引用可以共存的问题，只是将报错从编译期推迟到运行时，从编译器错误变成了 panic 异常\n\nuse std::cell::RefCell;\n\nfn main() {\n    let s = RefCell::new(String::from(\"hello, world\"));\n    let s1 = s.borrow();\n    let s2 = s.borrow_mut();\n\n    println!(\"{},{}\", s1, s2);\n}\n\n上面代码在编译期不会报任何错误，你可以顺利运行程序：\n但是依然会因为违背了借用规则导致了运行期 panic\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20251030224633-7mptjgi","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20251030224633-7mptjgi","updated":"20251030224904"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://course.rs/advance/smart-pointer/cell-refcell.html#refcell-%E4%B8%BA%E4%BD%95%E5%AD%98%E5%9C%A8","TextMarkTextContent":"RefCell 为何存在"}]},{"ID":"20251030224657-677ddwh","Type":"NodeParagraph","Properties":{"id":"20251030224657-677ddwh","updated":"20251030224709"},"Children":[{"Type":"NodeText","Data":"Rust 编译期的"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"宁可错杀，绝不放过"},{"Type":"NodeText","Data":"的原则，当编译器不能确定你的代码是否正确时，就统统会判定为错误，因此难免会导致一些误报。"}]},{"ID":"20251030224713-k2lg3c6","Type":"NodeParagraph","Properties":{"id":"20251030224713-k2lg3c6","updated":"20251030224714"},"Children":[{"Type":"NodeText","Data":"而 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"RefCell"},{"Type":"NodeText","Data":"​ 正是"},{"Type":"NodeTextMark","TextMarkType":"strong","TextMarkTextContent":"用于你确信代码是正确的，而编译器却发生了误判时"},{"Type":"NodeText","Data":"。"}]},{"ID":"20251030224907-nmwvc1y","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20251030224907-nmwvc1y","updated":"20251030224908"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://course.rs/advance/smart-pointer/cell-refcell.html#refcell-%E7%AE%80%E5%8D%95%E6%80%BB%E7%BB%93","TextMarkTextContent":"RefCell 简单总结"}]},{"ID":"20251030224904-y8javw7","Type":"NodeList","ListData":{},"Properties":{"id":"20251030224904-y8javw7","updated":"20251030224904"},"Children":[{"ID":"20251030224904-8ts6nfc","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251030224904-8ts6nfc","updated":"20251030224904"},"Children":[{"ID":"20251030224904-uovtseh","Type":"NodeParagraph","Properties":{"id":"20251030224904-uovtseh","updated":"20251030224904"},"Children":[{"Type":"NodeText","Data":"与 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Cell"},{"Type":"NodeText","Data":"​ 用于可 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"Copy"},{"Type":"NodeText","Data":"​ 的值不同，"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"RefCell"},{"Type":"NodeText","Data":"​ 用于引用"}]}]},{"ID":"20251030224904-boqc9ip","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251030224904-boqc9ip","updated":"20251030224904"},"Children":[{"ID":"20251030224904-xjnybej","Type":"NodeParagraph","Properties":{"id":"20251030224904-xjnybej","updated":"20251030224904"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"RefCell"},{"Type":"NodeText","Data":"​ 只是将借用规则从编译期推迟到程序运行期，并不能帮你绕过这个规则"}]}]},{"ID":"20251030224904-3qy3g3e","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251030224904-3qy3g3e","updated":"20251030224904"},"Children":[{"ID":"20251030224904-o4tpmca","Type":"NodeParagraph","Properties":{"id":"20251030224904-o4tpmca","updated":"20251030224904"},"Children":[{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"RefCell"},{"Type":"NodeText","Data":"​ 适用于编译期误报或者一个引用被在多处代码使用、修改以至于难于管理借用关系时"}]}]},{"ID":"20251030224904-unypecq","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251030224904-unypecq","updated":"20251030224904"},"Children":[{"ID":"20251030224904-wsfbuj1","Type":"NodeParagraph","Properties":{"id":"20251030224904-wsfbuj1","updated":"20251030224904"},"Children":[{"Type":"NodeText","Data":"使用 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"RefCell"},{"Type":"NodeText","Data":"​ 时，违背借用规则会导致运行期的 "},{"Type":"NodeTextMark","TextMarkType":"code","TextMarkTextContent":"panic"},{"Type":"NodeText","Data":"​"}]}]}]},{"ID":"20251030225038-mmf218m","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20251030225038-mmf218m","updated":"20251030230627"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://course.rs/advance/smart-pointer/cell-refcell.html#%E9%80%89%E6%8B%A9-cell-%E8%BF%98%E6%98%AF-refcell","TextMarkTextContent":"选择 "},{"Type":"NodeTextMark","TextMarkType":"a code","TextMarkAHref":"https://course.rs/advance/smart-pointer/cell-refcell.html#%E9%80%89%E6%8B%A9-cell-%E8%BF%98%E6%98%AF-refcell","TextMarkTextContent":"Cell"},{"Type":"NodeText","Data":"​"},{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://course.rs/advance/smart-pointer/cell-refcell.html#%E9%80%89%E6%8B%A9-cell-%E8%BF%98%E6%98%AF-refcell","TextMarkTextContent":" 还是 "},{"Type":"NodeTextMark","TextMarkType":"a code","TextMarkAHref":"https://course.rs/advance/smart-pointer/cell-refcell.html#%E9%80%89%E6%8B%A9-cell-%E8%BF%98%E6%98%AF-refcell","TextMarkTextContent":"RefCell"},{"Type":"NodeText","Data":"​"}]},{"ID":"20251030225039-c5bcxft","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20251030225039-c5bcxft","updated":"20251030225043"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"aWZjb25maWc="},{"Type":"NodeCodeBlockCode","Data":"Cell 只适用于 Copy 类型，用于提供值，而 RefCell 用于提供引用\nCell 不会 panic，而 RefCell 会\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20251030225047-d4y9ehk","Type":"NodeHeading","HeadingLevel":4,"Properties":{"id":"20251030225047-d4y9ehk","updated":"20251030230627"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://course.rs/advance/smart-pointer/cell-refcell.html#%E6%80%A7%E8%83%BD%E6%AF%94%E8%BE%83","TextMarkTextContent":"性能比较"}]},{"ID":"20251030225048-ypltir9","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20251030225048-ypltir9","updated":"20251030230627"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"aWZjb25maWc="},{"Type":"NodeCodeBlockCode","Data":"当非要使用内部可变性时，首选 Cell，只有你的类型没有实现 Copy 时，才去选择 RefCell\n因为refcell要先借用在调用方法\n\nuse std::cell::RefCell;\n\nfn main() {\n    let c = RefCell::new(String::from(\"asdf\"));\n    \n    // 获取不可变引用并复制值（因为 String 不实现 Copy，需要显式克隆）\n    let one = c.borrow().clone();\n    \n    // 获取可变引用并修改值\n    *c.borrow_mut() = String::from(\"qwer\");\n    \n    // 再次获取值\n    let two = c.borrow().clone();\n    \n    println!(\"{}, {}\", one, two); // 输出：asdf, qwer\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20251030230636-na4h6z8","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20251030230636-na4h6z8","updated":"20251030230637"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://course.rs/advance/smart-pointer/cell-refcell.html#%E5%86%85%E9%83%A8%E5%8F%AF%E5%8F%98%E6%80%A7","TextMarkTextContent":"内部可变性"}]},{"ID":"20251030230636-wi00txf","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20251030230636-wi00txf","updated":"20251030230637"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"aWZjb25maWc="},{"Type":"NodeCodeBlockCode"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]}]}