{"ID":"20251112221630-ef99rxi","Spec":"1","Type":"NodeDocument","Properties":{"id":"20251112221630-ef99rxi","title":"结构体自引用","type":"doc","updated":"20251113225551"},"Children":[{"ID":"20251112225434-m7qmw37","Type":"NodeParagraph","Properties":{"id":"20251112225434-m7qmw37","updated":"20251112225636"},"Children":[{"Type":"NodeText","Data":"自引用生命周期变化，s的所有权发生转移"}]},{"ID":"20251112221630-87zuvzb","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20251112221630-87zuvzb","updated":"20251112225427"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"aWZjb25maWc="},{"Type":"NodeCodeBlockCode","Data":"struct SelfRef\u003c'a\u003e {\n    value: String,\n\n    // 该引用指向上面的value\n    pointer_to_value: \u0026'a str,\n}\nfn main(){\n    let s = \"aaa\".to_string();\n    let v = SelfRef {\n        value: s,\n        pointer_to_value: \u0026s\n    };\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20251112225637-gp3nbs9","Type":"NodeParagraph","Properties":{"id":"20251112225637-gp3nbs9","updated":"20251112225810"},"Children":[{"Type":"NodeText","Data":"用Option：返回对的name发生所有权转移，'a生命周期凭空出现"}]},{"ID":"20251112225721-ab07ia1","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20251112225721-ab07ia1","updated":"20251112225728"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"aWZjb25maWc="},{"Type":"NodeCodeBlockCode","Data":"fn creator\u003c'a\u003e() -\u003e WhatAboutThis\u003c'a\u003e {\n    let mut tricky = WhatAboutThis {\n        name: \"Annabelle\".to_string(),\n        nickname: None,\n    };\n    tricky.nickname = Some(\u0026tricky.name[..4]);\n\n    tricky\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20251113225033-i199yoa","Type":"NodeParagraph","Properties":{"id":"20251113225033-i199yoa","updated":"20251113225119"},"Children":[{"Type":"NodeText","Data":"使用pin：pin会固定住一个值，后章节详解"}]},{"ID":"20251113225045-4rkkbjj","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20251113225045-4rkkbjj","updated":"20251113225054"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"aWZjb25maWc="},{"Type":"NodeCodeBlockCode","Data":"use std::marker::PhantomPinned;\nuse std::pin::Pin;\nuse std::ptr::NonNull;\n\n// 下面是一个自引用数据结构体，因为 slice 字段是一个指针，指向了 data 字段\n// 我们无法使用普通引用来实现，因为违背了 Rust 的编译规则\n// 因此，这里我们使用了一个裸指针，通过 NonNull 来确保它不会为 null\nstruct Unmovable {\n    data: String,\n    slice: NonNull\u003cString\u003e,\n    _pin: PhantomPinned,\n}\n\nimpl Unmovable {\n    // 为了确保函数返回时数据的所有权不会被转移，我们将它放在堆上，唯一的访问方式就是通过指针\n    fn new(data: String) -\u003e Pin\u003cBox\u003cSelf\u003e\u003e {\n        let res = Unmovable {\n            data,\n            // 只有在数据到位时，才创建指针，否则数据会在开始之前就被转移所有权\n            slice: NonNull::dangling(),\n            _pin: PhantomPinned,\n        };\n        let mut boxed = Box::pin(res);\n\n        let slice = NonNull::from(\u0026boxed.data);\n        // 这里其实安全的，因为修改一个字段不会转移整个结构体的所有权\n        unsafe {\n            let mut_ref: Pin\u003c\u0026mut Self\u003e = Pin::as_mut(\u0026mut boxed);\n            Pin::get_unchecked_mut(mut_ref).slice = slice;\n        }\n        boxed\n    }\n}\n\nfn main() {\n    let unmoved = Unmovable::new(\"hello\".to_string());\n    // 只要结构体没有被转移，那指针就应该指向正确的位置，而且我们可以随意移动指针\n    let mut still_unmoved = unmoved;\n    assert_eq!(still_unmoved.slice, NonNull::from(\u0026still_unmoved.data));\n\n    // 因为我们的类型没有实现 `Unpin` 特征，下面这段代码将无法编译\n    // let mut new_unmoved = Unmovable::new(\"world\".to_string());\n    // std::mem::swap(\u0026mut *still_unmoved, \u0026mut *new_unmoved);\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20251113225125-33p0pnn","Type":"NodeHeading","HeadingLevel":2,"Properties":{"id":"20251113225125-33p0pnn","updated":"20251113225551"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://course.rs/advance/circle-self-ref/self-referential.html#%E4%BD%BF%E7%94%A8-ouroboros","TextMarkTextContent":"使用 ouroboros"},{"Type":"NodeText","Data":"：这是一个三方库"}]},{"ID":"20251113225126-ycfsne2","Type":"NodeCodeBlock","IsFencedCodeBlock":true,"Properties":{"id":"20251113225126-ycfsne2","updated":"20251113225135"},"Children":[{"Type":"NodeCodeBlockFenceOpenMarker","Data":"```"},{"Type":"NodeCodeBlockFenceInfoMarker","CodeBlockInfo":"aWZjb25maWc="},{"Type":"NodeCodeBlockCode","Data":"use ouroboros::self_referencing;\n\n#[self_referencing]\nstruct SelfRef {\n    value: String,\n\n    #[borrows(value)]\n    pointer_to_value: \u0026'this str,\n}\n\nfn main(){\n    let v = SelfRefBuilder {\n        value: \"aaa\".to_string(),\n        pointer_to_value_builder: |value: \u0026String| value,\n    }.build();\n\n    // 借用value值\n    let s = v.borrow_value();\n    // 借用指针\n    let p = v.borrow_pointer_to_value();\n    // value值和指针指向的值相等\n    assert_eq!(s, *p);\n}\n"},{"Type":"NodeCodeBlockFenceCloseMarker","Data":"```"}]},{"ID":"20251113225543-a7jvpzq","Type":"NodeParagraph","Properties":{"id":"20251113225543-a7jvpzq","updated":"20251113225543"},"Children":[{"Type":"NodeText","Data":"类似的库还有："}]},{"ID":"20251113225543-ej6hor6","Type":"NodeList","ListData":{},"Properties":{"id":"20251113225543-ej6hor6","updated":"20251113225543"},"Children":[{"ID":"20251113225543-a24szhn","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251113225543-a24szhn","updated":"20251113225543"},"Children":[{"ID":"20251113225543-fc9kbqi","Type":"NodeParagraph","Properties":{"id":"20251113225543-fc9kbqi","updated":"20251113225543"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://github.com/jpernst/rental","TextMarkTextContent":"rental"},{"Type":"NodeText","Data":"， 这个库其实是最有名的，但是好像不再维护了，用倒是没问题"}]}]},{"ID":"20251113225543-n9umjbp","Type":"NodeListItem","ListData":{"BulletChar":42,"Marker":"Kg=="},"Properties":{"id":"20251113225543-n9umjbp","updated":"20251113225543"},"Children":[{"ID":"20251113225543-2b7j2z3","Type":"NodeParagraph","Properties":{"id":"20251113225543-2b7j2z3","updated":"20251113225543"},"Children":[{"Type":"NodeTextMark","TextMarkType":"a","TextMarkAHref":"https://github.com/Kimundi/owning-ref-rs","TextMarkTextContent":"owning-ref"},{"Type":"NodeText","Data":"，将所有者和它的引用绑定到一个封装类型"}]}]}]},{"ID":"20251113225551-cth0eob","Type":"NodeParagraph","Properties":{"id":"20251113225551-cth0eob","updated":"20251113225551"},"Children":[{"Type":"NodeText","Data":"rental 虽然不怎么维护，但是可能依然是这三个里面最强大的"}]},{"ID":"20251113225551-a8zqs26","Type":"NodeParagraph","Properties":{"id":"20251113225551-a8zqs26","updated":"20251113225551"}}]}